#!/bin/bash
#
# Script to add a new package to the aptly repository
# Usage: ./add-package.sh <path-to-deb-file>
#

set -e

if [ $# -ne 1 ]; then
    echo "Usage: $0 <path-to-deb-file>"
    echo "Example: $0 /tmp/ntfy_2.11.0_amd64.deb"
    exit 1
fi

DEB_FILE="$1"
REPO_NAME="{{ aptly_repo_name }}"
DISTRIBUTION="{{ aptly_distribution }}"
APTLY_HOME="{{ aptly_home }}"
APTLY_CONFIG="{{ aptly_config_dir }}/aptly.conf"

if [ ! -f "$DEB_FILE" ]; then
    echo "Error: File $DEB_FILE does not exist"
    exit 1
fi

if [ ! -f "$APTLY_CONFIG" ]; then
    echo "Error: Aptly configuration file $APTLY_CONFIG not found"
    exit 1
fi

echo "Adding package $DEB_FILE to repository $REPO_NAME..."

cd "$APTLY_HOME"
export GNUPGHOME="$APTLY_HOME/.gnupg"

# Add package to repository
aptly -config="$APTLY_CONFIG" repo add "$REPO_NAME" "$DEB_FILE"

# Update published repository
aptly -config="$APTLY_CONFIG" publish update "$DISTRIBUTION" "{{ aptly_publish_endpoint }}"

echo "Package successfully added and repository updated!"
echo "You can now install the package with:"
echo "  curl -fsSL http://{{ nginx_aptly_server_name }}/Release.key | sudo apt-key add -"
echo "  echo 'deb http://{{ nginx_aptly_server_name }} $DISTRIBUTION main' | sudo tee /etc/apt/sources.list.d/ntfy.list"
echo "  sudo apt update && sudo apt install ntfy"