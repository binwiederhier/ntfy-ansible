#!/bin/bash

. /etc/custom/custom.conf

check_truncate() {
  local output
  output=$(sqlite3 "$1" "PRAGMA wal_checkpoint(TRUNCATE);" 2>&1)
  echo "$output" | grep -qE '^0[ ]+0[ ]+0'
}

cache_ok=false
user_ok=false
webpush_ok=false

for i in $(seq 1 10); do
  if ! $cache_ok; then
    check_truncate /var/cache/ntfy/cache.db && cache_ok=true
  fi
  if ! $user_ok; then
    check_truncate /var/lib/ntfy/user.db && user_ok=true
  fi
  if ! $webpush_ok; then
    check_truncate /var/lib/ntfy/webpush.db && webpush_ok=true
  fi

  if $cache_ok && $user_ok && $webpush_ok; then
    break
  fi

  sleep 1
done

if $cache_ok && $user_ok && $webpush_ok; then
  curl -s \
    -H "Title: WAL truncate successful on $(hostname)" \
    -H "Tags: white_check_mark" \
    -H "Priority: low" \
    -d "WAL checkpoint truncate completed (cache_ok=$cache_ok, user_ok=$user_ok, webpush_ok=$webpush_ok)" \
    "${ntfy_topic_url}"
else
  curl -s \
    -H "Title: WAL truncate FAILED on $(hostname)" \
    -H "Tags: warning,rotating_light" \
    -d "WAL checkpoint truncate failed after 10 attempts (cache_ok=$cache_ok, user_ok=$user_ok, webpush_ok=$webpush_ok)" \
    "${ntfy_topic_url}"
  exit 1
fi
